var KNStaticAssets={};KNStaticAssets["KNTransitionSwoosh_Shadow.png"]=new Image,KNStaticAssets["KNTransitionSwoosh_Shadow.png"].src=static_url("KNTransitionSwoosh_Shadow.png"),KNStaticAssets["KNTransitionSlide_Black.png"]=new Image,KNStaticAssets["KNTransitionSlide_Black.png"].src=static_url("KNTransitionSlide_Black.png");var TextureManager=Class.create({initialize:function(e){this.script=null,this.showUrl=e,this.sceneCache={},this.slideCache={},this.sceneDidLoadCallbackHandler=null,this.viewScale=1,document.observe(kScriptDidDownloadEvent,function(e){this.handleScriptDidDownloadEvent(e)}.bind(this),!1)},setSceneDidLoadCallbackHandler:function(e,t){this.sceneDidLoadCallbackHandler={handler:e,sceneIndex:t}},processTextureDidLoadCallback:function(e,t){if(this.sceneDidLoadCallbackHandler==null)return;var n=this.sceneDidLoadCallbackHandler.sceneIndex,r=this.script.slideIndexFromSceneIndexLookup[n];if(r!=t)return;this.isSlidePreloaded(t)&&this.callSceneDidLoadCallback()},processSlideDidLoadCallback:function(e){if(this.sceneDidLoadCallbackHandler==null)return;var t=this.sceneDidLoadCallbackHandler.sceneIndex,n=this.script.slideIndexFromSceneIndexLookup[t];if(n!=e)return;this.callSceneDidLoadCallback()},processSceneDidLoadCallback:function(e){this.sceneDidLoadCallbackHandler&&e===this.sceneDidLoadCallbackHandler.sceneIndex&&this.isScenePreloaded(e)&&this.callSceneDidLoadCallback()},callSceneDidLoadCallback:function(){this.sceneDidLoadCallbackHandler.handler(),this.sceneDidLoadCallbackHandler=null},loadScene:function(e,t){if(e<0||e>this.script.numScenes)return;t&&this.setSceneDidLoadCallbackHandler(t,e);var n=this.script.slideIndexFromSceneIndexLookup[e];this.delegate.loadTextureBySlideIndex?this.assetForSlide(n):this.requestTexturesForSlide(n)},preloadScenes:function(e){for(var t in e){var n=this.script.slideIndexFromSceneIndexLookup[t];if(n==null)continue;this.slideCache.hasOwnProperty(n)===!1&&this.loadScene(t)}},isSlidePreloaded:function(e){var t=!1;if(this.slideCache[e]){t=!0;for(var n in this.slideCache[e].textureRequests)if(this.slideCache[e].textureRequests[n]===!1){t=!1;break}}return t},isScenePreloaded:function(e){var t=this.script.slideIndexFromSceneIndexLookup[e],n=this.isSlidePreloaded(t);return n},handleScriptDidDownloadEvent:function(e){this.script=e.memo.script,this.delegate=e.memo.delegate},assetForSlide:function(e){var t=this.slideCache[e],n=this.script.slideList[e],r=this.script.slides[n],i=r.assets;if(t==null){this.slideCache[e]={},this.slideCache[e].textureAssets={},this.slideCache[e].textureRequests={};for(var s in i){var o=i[s];o.type==="texture"&&(this.slideCache[e].textureRequests[s]=!1,this.requestAsset(s,o,n,e))}}else if(this.isSlidePreloaded(e))this.processSlideDidLoadCallback(e);else for(var s in i){var o=i[s];this.slideCache[e].textureRequests[s]===!1&&o.type==="texture"&&this.requestAsset(s,o,n,e)}},requestAsset:function(e,t,n,r){requestedSlideIndex=r,t.assetRequest.type==="slide"&&(t.assetRequest.state==="incoming"||t.assetRequest.state==="incoming-reflection")&&(t.assetRequest.slide?(requestedSlideIndex=this.script.slideList.indexOf(t.assetRequest.slide),requestedSlideIndex===-1&&(this.script.loopSlideshow?requestedSlideIndex=0:(requestedSlideIndex=r,t.assetRequest.state="KNTransitionSlide_Black.png"))):r<this.script.slideList.length-1?requestedSlideIndex=r+1:this.script.loopSlideshow?requestedSlideIndex=0:(requestedSlideIndex=r,t.assetRequest.state="KNTransitionSlide_Black.png")),t.assetRequest.state==="incoming"||t.assetRequest.state==="incoming-reflection"||t.assetRequest.state==="outgoing"||t.assetRequest.state==="outgoing-reflection"?this.delegate.loadTextureBySlideIndex(requestedSlideIndex,t.assetRequest,function(t,n,i){this.slideCache[n].textureAssets[t]=i,this.slideCache[n].textureRequests[t]=!0,this.processTextureDidLoadCallback(e,r)}.bind(this,e,r)):(this.slideCache[r].textureAssets[e]=KNStaticAssets[t.assetRequest.state],this.slideCache[r].textureRequests[e]=!0)},requestTexturesForSlide:function(e){var t=this.slideCache[e],n=this.script.slideList[e],r=this.script.slides[n],i=r.assets;if(t==null){this.slideCache[e]={},this.slideCache[e].textureAssets={},this.slideCache[e].textureRequests={};for(var s in i){var o=i[s];o.type==="texture"&&(this.slideCache[e].textureRequests[s]=!1,this.fetchTexture(s,n,e))}}else if(this.isSlidePreloaded(e))this.processSlideDidLoadCallback(e);else for(var s in i){var o=i[s];this.slideCache[e].textureRequests[s]===!1&&o.type==="texture"&&this.fetchTexture(s,n,e)}},fetchTexture:function(e,t,n){var r=this.urlForTexture(e,t),i=r.substr(r.length-3);if(i==="png"){var s=new Image;Event.observe(s,"load",this.handleImageOnloadEvent.bind(this,e,n)),s.src=r;return}if(window.location.protocol==="file:"){r+="p";if(window.local_svg==null||window.local_svg==undefined)window.local_svg=function(e){this.handleFetchCompleted(null,e,!0)}.bind(this);var o=document.createElement("script");o.setAttribute("src",r),document.head.appendChild(o)}else{var u={textureId:e,slideId:t,slideIndex:n};new Ajax.Request(r,{method:"get",onSuccess:this.handleFetchCompleted.bind(this,u)})}},handleFetchCompleted:function(e,t,n){var r=this.viewScale,i,s;n?(i=t.name,slideId=t.slide,s=this.script.slideList.indexOf(slideId)):(i=e.textureId,slideId=e.slideId,s=e.slideIndex);var o=this.urlForTexture(i,slideId),u=o.substring(0,o.lastIndexOf("/")+1),a,f=new DOMParser;n?a=f.parseFromString(t.svg,"text/xml"):browserPrefix==="ms"&&browserVersion<10?a=f.parseFromString(t.responseText,"text/xml"):a=t.responseXML;var l=a.documentElement.getAttribute("viewBox").split(" "),c=l[2],h=l[3],p=a.getElementsByTagName("image");for(var d=0,v=p.length;d<v;d++){var m=p[d],g=m.getAttributeNS("http://www.w3.org/1999/xlink","href");m.setAttributeNS("http://www.w3.org/1999/xlink","href",u+g)}var y=document.importNode(a.documentElement,!0);y.setAttributeNS("http://www.w3.org/2000/svg","width",c),y.setAttributeNS("http://www.w3.org/2000/svg","height",h),this.slideCache[s].textureAssets[i]=y,this.slideCache[s].textureRequests[i]=!0,this.processTextureDidLoadCallback(i,s)},setViewScale:function(e){this.viewScale!==e&&(this.viewScale=e,this.sceneCache=null,this.sceneCache={})},handleImageOnloadEvent:function(e,t,n){n=n||window.event;var r=n.target||n.srcElement;this.slideCache[t].textureAssets[e]=r,this.slideCache[t].textureRequests[e]=!0,this.processTextureDidLoadCallback(e,t)},getTextureObject:function(e,t){var n,r=this.script.slideIndexFromSceneIndexLookup[e];return n=this.slideCache[r].textureAssets[t],n},getTextureInfo:function(e,t){var n=this.script.slideIndexFromSceneIndexLookup[e];if(n==null)return null;var r=this.script.slideList[n],i=this.script.slides[r].assets[t];return i},getTextureUrl:function(e,t){var n=this.script.slideIndexFromSceneIndexLookup[e];if(n==null)return null;var r=this.script.slideList[n];return this.urlForTexture(t,r)},getMovieUrl:function(e,t){var n=this.script.slideIndexFromSceneIndexLookup[e];if(n==null)return null;var r=this.script.slideList[n];return this.urlForMovie(t,r)},urlForAsset:function(e,t){var n="",r=this.script.slides[t].assets[e];if(r==null)return n;var i=r.url;return i!=null&&i!=""&&(i.toLowerCase().substring(0,4)==="http"?n=i:n=this.showUrl+(t?t+"/":"")+i),n},urlForMovie:function(e,t){return this.generateUrl(e,t,!0)},urlForTexture:function(e,t){return this.generateUrl(e,t,!1)},generateUrl:function(e,t,n){var r="",i="",s=this.script.slides[t].assets[e];if(s===null)return r;if(n){var o=this.script.slides[t].assets[s.movie];i=o.url}else i=s.url;return i!=null&&i!=""&&(i.toLowerCase().substring(0,4)==="http"?r=i:r=this.showUrl+(t?t+"/":"")+i),r},scenesInCache:function(){var e="";for(var t in this.sceneCache)e!=""&&(e+=", "),e+=t;return e}});