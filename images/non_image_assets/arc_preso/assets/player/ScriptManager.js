var kShowSizeDidChangeEvent="ScriptManager:ShowSizeDidChangeEvent",kScriptDidDownloadEvent="ScriptManager:ScriptDidDownloadEvent",kScriptDidNotDownloadEvent="ScriptManager:ScriptDidNotDownloadEvent",kSlideDidDownloadEvent="SlideManager:SlideDidDownloadEvent",kSlideDidNotDownloadEvent="SlideManager:SlideDidNotDownloadEvent",ScriptManager=Class.create({initialize:function(e){this.script=null,this.showUrl=e,this.slideManager=null,document.observe(kSlideDidDownloadEvent,this.handleSlideDidDownloadEvent.bind(this)),document.observe(kSlideDidNotDownloadEvent,this.handleSlideDidDownloadEvent.bind(this))},handleSlideDidDownloadEvent:function(e){var t=!0;for(var n in this.slideManager.slides)if(this.slideManager.slides.hasOwnProperty(n)&&!this.slideManager.slides[n].downloaded){t=!1;break}if(t){this.script.events=[],this.script.originalEvents=[],this.script.slideIndexFromSceneIndexLookup={},this.script.sceneIndexFromSlideIndexLookup={},this.script.slides={},this.script.originalSlides={};var r,i,s,o,u=0,a=0,f=0;for(var n in this.slideManager.slides)if(this.slideManager.slides.hasOwnProperty(n)){s=this.slideManager.slides[n].script,o=this.slideManager.slides[n].originalScript,r=s.events,i=o.events,this.script.slides[n]=s,this.script.originalSlides[n]=o,this.script.sceneIndexFromSlideIndexLookup[u]=a;for(var l=0,c=r.length;l<c;l++)this.script.events.push(r[l]),this.script.originalEvents.push(i[l]),this.script.slideIndexFromSceneIndexLookup[f]=u,f+=1;u+=1,a=f}this.script.numScenes=this.script.events.length,this.script.lastSceneIndex=this.script.numScenes-1,this.script.lastSlideIndex=this.script.slideList.length-1,this.script.originalSlideWidth=this.script.slideWidth,this.script.originalSlideHeight=this.script.slideHeight,browserPrefix==="ms"?this.adjustScriptForIE():this.adjustScript(),this.delegate.setViewScale&&(this.applyScaleFactor(),this.delegate.setViewScale(this.scaleFactor));if(this.delegate.isUsingPreloadedFont&&this.delegate.isUsingPreloadedFont()){var h=document.createElement("style");h.type="text/css",h.appendChild(document.createTextNode(this.delegate.getFontFamilyDefinitionsCssString())),document.getElementsByTagName("head")[0].appendChild(h)}else this.getFontFamilyDefinitionsCssString();document.fire(kScriptDidDownloadEvent,{script:this.script,delegate:this.delegate}),document.fire(kShowSizeDidChangeEvent,{width:this.script.slideWidth,height:this.script.slideHeight})}},getFontFamilyDefinitionsCssString:function(){typeof GSFT=="undefined"&&(GSFT={}),GSFT.FontFamilyDefinitionsJsonp=GSFT.FontFamilyDefinitionsJsonp||{},GSFT.FontFamilyDefinitionsJsonp.urlPrefix="https://www.icloud.com",GSFT.FontFamilyDefinitionsJsonp.cssStringDictReady=function(e){var t="",n=gShowController.scriptManager.script.fonts,r=document.createElement("style");r.type="text/css";for(var i=0,s=n.length;i<s;i++){var o=n[i];e[o]&&(t+=e[o])}r.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(r)},function(){var e=document.createElement("script");e.src=GSFT.FontFamilyDefinitionsJsonp.urlPrefix+"/iw/fonts/font_family_definitions_jsonp.json",document.getElementsByTagName("head")[0].appendChild(e)}()},adjustScript:function(){for(var e=0,t=this.script.events.length;e<t;e++){var n=this.script.events[e],r=this.script.originalEvents[e];for(var i=0,s=n.effects.length;i<s;i++){var o=n.effects[i],u=r.effects[i];this.adjustEffects(o,u),this.adjustEmphasisBuilds(o,u),isMacOS&&isChrome&&this.adjustEffectsForChrome(o,u),browserPrefix==="moz"&&this.adjustEffectsForFirefox(o,u)}for(var i=0,a=n.hyperlinks.length;i<a;i++){var f=n.hyperlinks[i],l=r.hyperlinks[i];for(var c in f.events){var h=f.events[c],p=l.events[c];for(var d=0,s=h.effects.length;d<s;d++){var v=h.effects[d],m=p.effects[d];this.adjustEffects(v,m),this.adjustEmphasisBuilds(v,m),isMacOS&&isChrome&&this.adjustEffectsForChrome(o,u),browserPrefix==="moz"&&this.adjustEffectsForFirefox(o,u)}}}}},adjustEffects:function(e,t){switch(e.name){case"apple:doorway":var n=t.baseLayer.layers[0],r=e.baseLayer.layers[0],i=n.layers[1];n.layers[1]=n.layers[2],n.layers[2]=i;var s=r.layers[1];r.layers[1]=r.layers[2],r.layers[2]=s,isChrome&&(n.layers[1].layers[0].initialState.masksToBounds=!0,n.layers[1].layers[1].initialState.masksToBounds=!0,r.layers[1].layers[0].initialState.masksToBounds=!0,r.layers[1].layers[1].initialState.masksToBounds=!0,n.layers[1].layers[0].layers[0].initialState.masksToBounds=!0,n.layers[1].layers[1].layers[0].initialState.masksToBounds=!0,r.layers[1].layers[0].layers[0].initialState.masksToBounds=!0,r.layers[1].layers[1].layers[0].initialState.masksToBounds=!0);break;case"apple:ca-isometric":for(var o=0,u=e.baseLayer.layers.length;o<u;o++){var a=e.baseLayer.layers[o],f=e.baseLayer.layers[o];this.adjustPerspective(a,f)}break;case"apple:apple-grid":var n=t.baseLayer.layers[0],r=e.baseLayer.layers[0];r.layers.splice(0,2),n.layers.splice(0,2);break;case"com.apple.iWork.Keynote.BLTSwoosh":var n=t.baseLayer.layers[0],r=e.baseLayer.layers[0];if(e.type==="transition"){r.layers[1].layers[0].layers.splice(0,1),n.layers[1].layers[0].layers.splice(0,1);var i=n.layers[1];n.layers[1]=n.layers[2],n.layers[2]=i;var s=r.layers[1];r.layers[1]=r.layers[2],r.layers[2]=s}break;default:}},adjustPerspective:function(e,t){if(e.animations[0]&&e.animations[0].animations.length>0){var n=e.animations[0].beginTime,r=e.animations[0].animations[0].beginTime,s=n===r?e.animations[0].animations:e.animations[0].animations[0].animations,o=n===r?t.animations[0].animations:t.animations[0].animations[0].animations;for(i=0,length=s.length;i<length;i++){var u=s[i],a=o[i];u.property==="sublayerTransform.rotation.x"?(u.property="transform.rotation.x",a.property="transform.rotation.x"):u.property==="sublayerTransform.rotation.y"?(u.property="transform.rotation.y",a.property="transform.rotation.y"):u.property==="sublayerTransform.transform.scale"&&(u.property="transform.scale",a.property="transform.scale")}}},adjustEmphasisBuilds:function(e,t){switch(e.name){case"apple:action-jiggle":var n=t.baseLayer.layers[0],r=e.baseLayer.layers[0],i=n.animations[0],s=r.animations[0],o=s.animations.length;for(var u=0;u<o;u++){var a=Math.ceil(s.duration/s.animations[u].duration);for(var f=0;f<a-1;f++){var l=JSON.parse(JSON.stringify(i.animations[u])),c=JSON.parse(JSON.stringify(s.animations[u]));l.beginTime=i.animations[u].duration*(f+1),c.beginTime=s.animations[u].duration*(f+1),n.animations[0].animations.push(l),r.animations[0].animations.push(c),f===a-2&&(l.duration=s.duration-l.beginTime,c.duration=s.duration-c.beginTime,s.animations[u].property==="transform.rotation.z"?(l.to.scalar=0,c.to.scalar=0):s.animations[u].property==="position"&&(l.to.pointX=(l.from.pointX+l.to.pointX)/2,c.to.pointX=(c.from.pointX+c.to.pointX)/2))}}break;case"apple:action-blink":case"apple:action-pulse":var n=t.baseLayer.layers[0],r=e.baseLayer.layers[0],i=n.animations[0],s=r.animations[0],h=[],p=[],d=0,a=1;s.repeatCount&&(a=Math.floor(s.repeatCount)),n.animations[0].duration=s.duration*a,r.animations[0].duration=s.duration*a;for(var u=0,o=s.animations.length;u<o;u++)p.push(JSON.stringify(s.animations[u])),h.push(JSON.stringify(i.animations[u])),d=s.animations[u].beginTime+s.animations[u].duration;for(var u=0;u<a-1;u++)for(var f=0,o=p.length;f<o;f++){var l=JSON.parse(h[f]),c=JSON.parse(p[f]);l.beginTime=d,c.beginTime=d,n.animations[0].animations.push(l),r.animations[0].animations.push(c),d=l.beginTime+l.duration}break;default:}for(var v=0,m=e.effects.length;v<m;v++)this.adjustEmphasisBuilds(e.effects[v],t.effects[v])},adjustEffectsForChrome:function(e,t){if(e.name==="none"){var n=t.baseLayer.layers[0],r=e.baseLayer.layers[0];n.layers[1].animations[0].animations&&n.layers[1].animations[0].animations.length>0?(n.layers[1].animations[0].animations[0].property="opacity",r.layers[1].animations[0].animations[0].property="opacity",n.layers[1].animations[0].animations[0].from={scalar:1},n.layers[1].animations[0].animations[0].to={scalar:0},r.layers[1].animations[0].animations[0].from={scalar:1},r.layers[1].animations[0].animations[0].to={scalar:0}):(n.layers[1].animations[0].property="opacity",r.layers[1].animations[0].property="opacity",n.layers[1].animations[0].from={scalar:1},n.layers[1].animations[0].to={scalar:0},r.layers[1].animations[0].from={scalar:1},r.layers[1].animations[0].to={scalar:0})}},adjustEffectsForFirefox:function(e,t){switch(e.name){case"apple:scale":var n=t.baseLayer.layers[0],r=e.baseLayer.layers[0];if(n.layers[0].animations.length>0){var i=n.layers[0];n.layers[0]=n.layers[1],n.layers[1]=i,n.layers[1].initialState.hidden=!0;var s=r.layers[0];r.layers[0]=r.layers[1],r.layers[1]=s,r.layers[1].initialState.hidden=!0;var o=n.layers[1].animations[0].beginTime,u=n.layers[1].animations[0].duration,a=n.layers[1].animations[0].animations[0].beginTime,f=n.layers[1].animations[0].animations[0].duration,l;if(o==a){for(var c=0,h=n.layers[1].animations[0].animations.length;c<h;c++)n.layers[1].animations[0].animations[c].property==="transform.translation.z"&&(n.layers[1].animations[0].animations.splice(c,1),r.layers[1].animations[0].animations.splice(c,1));l={animations:[],beginTime:o,duration:u,fillMode:"forwards",from:{scalar:!1},property:"hidden",timingFunction:"linear",to:{scalar:!1}},n.layers[1].animations[0].animations.push(l),r.layers[1].animations[0].animations.push(l)}else{for(var c=0,h=n.layers[1].animations[0].animations[0].animations.length;c<h;c++)n.layers[1].animations[0].animations[0].animations[c].property==="transform.translation.z"&&(n.layers[1].animations[0].animations[0].animations.splice(c,1),r.layers[1].animations[0].animations[0].animations.splice(c,1));l={animations:[],beginTime:n.layers[1].animations[0].animations[0].animations[0].beginTime+.03,duration:n.layers[1].animations[0].animations[0].animations[0].duration,fillMode:"forwards",from:{scalar:!1},property:"hidden",timingFunction:"linear",to:{scalar:!1}},n.layers[1].animations[0].animations[0].animations.push(l),r.layers[1].animations[0].animations[0].animations.push(l)}}break;case"com.apple.iWork.Keynote.KLNSwap":var n=t.baseLayer.layers[0],r=e.baseLayer.layers[0],f,p,d,v,m;if(n.layers[1].animations[0].animations.length>1){for(var c=0,h=n.layers[1].animations[0].animations.length;c<h;c++){v=n.layers[1].animations[0].animations[c],m=r.layers[1].animations[0].animations[c];if(v.property==="opacity")break}f=n.layers[1].animations[0].duration}else{for(var c=0,h=n.layers[1].animations[0].animations[0].animations.length;c<h;c++){v=n.layers[1].animations[0].animations[0].animations[c],m=r.layers[1].animations[0].animations[0].animations[c];if(v.property==="opacity")break}f=n.layers[1].animations[0].animations[0].duration}p=f*.4,d=f*.4,v.to.scalar=0,v.beginTime=p,v.duration=d,m.to.scalar=0,m.beginTime=p,m.duration=d;break;default:}},adjustScriptForIE:function(){for(var e=0,t=this.script.events.length;e<t;e++){var n=this.script.events[e],r=this.script.originalEvents[e];for(var i=0,s=n.effects.length;i<s;i++){var o=n.effects[i],u=r.effects[i];this.adjustEffectsForIE(o,u),this.adjustEmphasisBuilds(o,u)}for(var i=0,a=n.hyperlinks.length;i<a;i++){var f=n.hyperlinks[i],l=r.hyperlinks[i];for(var c in f.events){var h=f.events[c],p=l.events[c];for(var d=0,s=h.effects.length;d<s;d++){var v=h.effects[d],m=p.effects[d];this.adjustEffectsForIE(v,m),this.adjustEmphasisBuilds(v,m)}}}}},adjustEffectsForIE:function(e,t){switch(e.name){case"apple:ca-isometric":for(var n=0,r=e.baseLayer.layers.length;n<r;n++){var i=e.baseLayer.layers[n],s=e.baseLayer.layers[n];this.adjustPerspective(i,s)}break;case"apple:bounce":case"apple:slide":case"apple:pivot":case"apple:scale":var o=t.baseLayer.layers[0],u=e.baseLayer.layers[0];if(o.layers[0].animations.length>0){var a=o.layers[0];o.layers[0]=o.layers[1],o.layers[1]=a,o.layers[1].initialState.hidden=!0;var f=u.layers[0];u.layers[0]=u.layers[1],u.layers[1]=f,u.layers[1].initialState.hidden=!0;var l=o.layers[1].animations[0].beginTime,c=o.layers[1].animations[0].duration,h=o.layers[1].animations[0].animations[0].beginTime,p=o.layers[1].animations[0].animations[0].duration,d;if(l==h){for(var v=0,m=o.layers[1].animations[0].animations.length;v<m;v++)o.layers[1].animations[0].animations[v].property==="transform.translation.z"&&(o.layers[1].animations[0].animations.splice(v,1),u.layers[1].animations[0].animations.splice(v,1));d={animations:[],beginTime:l,duration:c,fillMode:"forwards",from:{scalar:!1},property:"hidden",timingFunction:"linear",to:{scalar:!1}},o.layers[1].animations[0].animations.push(d),u.layers[1].animations[0].animations.push(d)}else{for(var v=0,m=o.layers[1].animations[0].animations[0].animations.length;v<m;v++)o.layers[1].animations[0].animations[0].animations[v].property==="transform.translation.z"&&(o.layers[1].animations[0].animations[0].animations.splice(v,1),u.layers[1].animations[0].animations[0].animations.splice(v,1));d={animations:[],beginTime:o.layers[1].animations[0].animations[0].animations[0].beginTime+.03,duration:o.layers[1].animations[0].animations[0].animations[0].duration,fillMode:"forwards",from:{scalar:!1},property:"hidden",timingFunction:"linear",to:{scalar:!1}},o.layers[1].animations[0].animations[0].animations.push(d),u.layers[1].animations[0].animations[0].animations.push(d)}}break;case"apple:doorway":var o=t.baseLayer.layers[0],u=e.baseLayer.layers[0],l=o.layers[0].animations[0].beginTime,c=o.layers[0].animations[0].duration,h=o.layers[0].animations[0].animations[0].beginTime,p=o.layers[0].animations[0].animations[0].duration;o.layers[0].layers=[],o.layers[0].animations=[],u.layers[0].layers=[],u.layers[0].animations=[],l==h?(o.layers[1].animations[0].animations[0].beginTime=h,o.layers[1].animations[0].animations[0].duration=p,u.layers[1].animations[0].animations[0].beginTime=h,u.layers[1].animations[0].animations[0].duration=p):(o.layers[1].animations[0].animations[0].animations[0].duration=p,u.layers[1].animations[0].animations[0].animations[0].duration=p),o.layers.splice(2,1),u.layers.splice(2,1);break;case"apple:3D-cube":case"com.apple.iWork.Keynote.BLTReflection":case"apple:revolve":case"com.apple.iWork.Keynote.BLTRevolvingDoor":var o=t.baseLayer.layers[0],u=e.baseLayer.layers[0],g;g={animations:[],beginTime:0,duration:t.duration,fillMode:"both",from:{scalar:1},property:"opacity",timingFunction:"easeInEaseOut",to:{scalar:0}},o.layers[0].layers=[],o.layers[0].animations=[],o.layers[1].layers=[],o.layers[1].animations=[],o.layers[1].animations.push(g),u.layers[0].layers=[],u.layers[0].animations=[],u.layers[1].layers=[],u.layers[1].animations=[],u.layers[1].animations.push(g);break;case"com.apple.iWork.Keynote.KLNSwap":var o=t.baseLayer.layers[0],u=e.baseLayer.layers[0],p,y,b,w,g;if(o.layers[1].animations[0].animations.length>1){for(var v=0,m=o.layers[1].animations[0].animations.length;v<m;v++){w=o.layers[1].animations[0].animations[v],g=u.layers[1].animations[0].animations[v];if(w.property==="opacity")break}p=o.layers[1].animations[0].duration}else{for(var v=0,m=o.layers[1].animations[0].animations[0].animations.length;v<m;v++){w=o.layers[1].animations[0].animations[0].animations[v],g=u.layers[1].animations[0].animations[0].animations[v];if(w.property==="opacity")break}p=o.layers[1].animations[0].animations[0].duration}y=p*.4,b=p*.4,w.to.scalar=0,w.beginTime=y,w.duration=b,g.to.scalar=0,g.beginTime=y,g.duration=b;break;case"apple:FlipThrough":var o=t.baseLayer.layers[0],u=e.baseLayer.layers[0];if(o.layers[0].animations.length>0){var a=JSON.parse(JSON.stringify(o.layers[1]));o.layers.splice(0,0,a);var f=JSON.parse(JSON.stringify(u.layers[1]));u.layers.splice(0,0,f);var l=o.layers[1].animations[0].beginTime,c=o.layers[1].animations[0].duration,h=o.layers[1].animations[0].animations[0].beginTime,p=o.layers[1].animations[0].animations[0].duration,d;if(l==h){for(var v=0,m=o.layers[1].animations[0].animations.length;v<m;v++)o.layers[1].animations[0].animations[v].property==="transform.translation.z"&&(o.layers[1].animations[0].animations.splice(v,1),u.layers[1].animations[0].animations.splice(v,1));d={animations:[],beginTime:l+c/2,duration:c/2,fillMode:"forwards",from:{scalar:!0},property:"hidden",timingFunction:"linear",to:{scalar:!0}},o.layers[2].animations[0].animations.push(d),u.layers[2].animations[0].animations.push(d)}else{for(var v=0,m=o.layers[1].animations[0].animations[0].animations.length;v<m;v++)o.layers[1].animations[0].animations[0].animations[v].property==="transform.translation.z"&&(o.layers[1].animations[0].animations[0].animations.splice(v,1),u.layers[1].animations[0].animations[0].animations.splice(v,1));d={animations:[],beginTime:o.layers[2].animations[0].animations[0].animations[0].beginTime+o.layers[2].animations[0].animations[0].animations[0].duration/2,duration:o.layers[2].animations[0].animations[0].animations[0].duration/2,fillMode:"forwards",from:{scalar:!0},property:"hidden",timingFunction:"linear",to:{scalar:!0}},o.layers[2].animations[0].animations[0].animations.push(d),u.layers[2].animations[0].animations[0].animations.push(d)}}break;default:}},handleSlideDidNotDownloadEvent:function(e){this.scriptDidNotDownload.bind(this)},reapplyScaleFactor:function(){this.delegate.setViewScale&&(this.applyScaleFactor(),this.delegate.setViewScale(this.scaleFactor))},applyScaleFactorForAnimation:function(e,t,n){var r=e.property;if(e.path)for(var i=0,s=e.path.length;i<s;i++){var o=e.path[i].points,u=t.path[i].points;o[0][0]=u[0][0]*n,o[0][1]=u[0][1]*n}switch(r){case"anchorPointZ":case"zPosition":case"transform.translation.x":case"transform.translation.y":e.from&&(e.from.scalar=t.from.scalar*n),e.to&&(e.to.scalar=t.to.scalar*n);if(e.values)for(var i=0,a=e.values.length;i<a;i++)e.values[i].scalar=t.values[i].scalar*n;break;case"transform.translation.z":e.from&&e.from.scalar!=1&&e.from.scalar!=.01&&(e.from.scalar=t.from.scalar*n),e.to&&e.to.scalar!=1&&e.to.scalar!=.01&&(e.to.scalar=t.to.scalar*n);if(e.values)for(var i=0,a=e.values.length;i<a;i++)e.values[i].scalar=t.values[i].scalar*n;break;case"position":case"transform.translation":e.from&&(e.from.pointX=t.from.pointX*n,e.from.pointY=t.from.pointY*n),e.to&&(e.to.pointX=t.to.pointX*n,e.to.pointY=t.to.pointY*n);if(e.values)for(var i=0,a=e.values.length;i<a;i++)e.values[i].pointX=t.values[i].pointX*n,e.values[i].pointY=t.values[i].pointY*n;break;case"transform":e.from&&(e.from.transform[12]=t.from.transform[12]*n,e.from.transform[13]=t.from.transform[13]*n,e.from.transform[14]=t.from.transform[14]*n),e.to&&(e.to.transform[12]=t.to.transform[12]*n,e.to.transform[13]=t.to.transform[13]*n,e.to.transform[14]=t.to.transform[14]*n);if(e.values)for(var i=0,a=e.values.length;i<a;i++)e.values[i].transform[12]=t.values[i].transform[12]*n,e.values[i].transform[13]=t.values[i].transform[13]*n,e.values[i].transform[14]=t.values[i].transform[14]*n;break;case"bounds":e.from&&(e.from.width=t.from.width*n,e.from.height=t.from.height*n),e.to&&(e.to.width=t.to.width*n,e.to.height=t.to.height*n);break;case"transform.scale.xy":case"transform.scale.x":case"transform.scale.y":}if(e.animations)for(var i=0,f=e.animations.length;i<f;i++)this.applyScaleFactorForAnimation(e.animations[i],t.animations[i],n)},applyScaleFactorForLayer:function(e,t,n,r,i,s){var o=e.initialState,u=t.initialState,a=u.contentsRect;o.affineTransform[4]=u.affineTransform[4]*n,o.affineTransform[5]=u.affineTransform[5]*n,o.width=u.width*n,o.height=u.height*n,o.position.pointX=u.position.pointX*n,o.position.pointY=u.position.pointY*n;switch(r){case"com.apple.iWork.Keynote.BLTMosaicFlip":this.adjustForCropAnimation(o,a,s.particleCount.x,s.particleCount.y);break;case"com.apple.iWork.Keynote.BLTReflection":var f=e.texture;if(f!=null){var l=this.script.slides[i].assets[f];if(l.assetRequest.state==="incoming-reflection"||l.assetRequest.state==="outgoing-reflection")o.height=o.height/2,o.position.pointY=o.position.pointY-o.height/2}break;default:}if(e.animations)for(var c=0,h=e.animations.length;c<h;c++)this.applyScaleFactorForAnimation(e.animations[c],t.animations[c],n);for(var c=0,h=e.layers.length;c<h;c++)this.applyScaleFactorForLayer(e.layers[c],t.layers[c],n,r,i,s)},applyScaleFactorForBaseLayer:function(e,t,n){var r=e.initialState,i=t.initialState;r.affineTransform[4]=i.affineTransform[4]*n,r.affineTransform[5]=i.affineTransform[5]*n,r.width=i.width*n,r.height=i.height*n,r.position.pointX=i.position.pointX*n,r.position.pointY=i.position.pointY*n;for(var s=0,o=e.layers.length;s<o;s++)this.applyScaleFactorForBaseLayer(e.layers[s],t.layers[s],n)},applyScaleFactor:function(){var e=this.script.originalSlideWidth,t=this.script.originalSlideHeight,n=window.innerWidth,r=window.innerHeight,i=scaleSizeWithinSize(e,t,n,r),s=i.width,o=i.height,u=o/t;this.scaleFactor=u,this.script.slideWidth=this.script.originalSlideWidth*u,this.script.slideHeight=this.script.originalSlideHeight*u;for(var a=0,f=this.script.events.length;a<f;a++){var l=this.script.events[a],c=this.script.originalEvents[a],h=this.script.slideIndexFromSceneIndexLookup[a],p=this.script.slideList[h];this.applyScaleFactorForBaseLayer(l.baseLayer,c.baseLayer,u);for(var d=0,v=l.effects.length;d<v;d++){var m=l.effects[d],g=c.effects[d],y={};if(m.name==="com.apple.iWork.Keynote.BLTMosaicFlip"){var b=0,w=0;for(var E=0,S=m.baseLayer.layers[0].layers.length;E<S;E++){var x=g.baseLayer.layers[0].layers[E],T=x.initialState.contentsRect,N=Math.round(T.x/T.width),C=Math.round(T.y/T.height);N>b&&(b=N),C>w&&(w=C)}y.particleCount={x:b+1,y:w+1}}this.applyScaleFactorForLayer(m.baseLayer,g.baseLayer,u,m.name,p,y)}for(var d=0,k=l.hyperlinks.length;d<k;d++){var L=l.hyperlinks[d],A=c.hyperlinks[d],O=L.targetRectangle,M=A.targetRectangle;O.y=M.y*u,O.x=M.x*u,O.width=M.width*u,O.height=M.height*u;for(var _ in L.events){var D=L.events[_],P=A.events[_];for(var H=0,v=D.effects.length;H<v;H++){var B=D.effects[H],j=P.effects[H],y={};if(B.name==="com.apple.iWork.Keynote.BLTMosaicFlip"){var b=0,w=0;for(var E=0,S=B.baseLayer.layers[0].layers.length;E<S;E++){var x=B.baseLayer.layers[0].layers[E],T=x.initialState.contentsRect,N=Math.round(T.x/T.width),C=Math.round(T.y/T.height);N>b&&(b=N),C>w&&(w=C)}y.particleCount={x:b+1,y:w+1}}this.applyScaleFactorForLayer(B.baseLayer,j.baseLayer,u,B.name,p,y)}}}}for(var F in this.script.slides)if(this.script.slides.hasOwnProperty(F)){var I=this.script.slides[F],q=this.script.originalSlides[F];for(var R in I.assets)if(I.assets.hasOwnProperty(R)){var U=I.assets[R],z=q.assets[R];U.width=z.width*u,U.height=z.height*u}}},adjustForCropAnimation:function(e,t,n,r){var i=this.script.slideWidth,s=this.script.slideHeight,o=Math.floor(i/n),u=Math.floor(s/r),a=Math.round(t.x/t.width),f=Math.round(t.y/t.height);if(t.width!=1||t.height!=1)a!=n-1?e.width=o:e.width=i-o*(n-1),f!=r-1?e.height=u:e.height=s-u*(r-1),e.position.pointX=o*a+e.width/2,e.position.pointY=u*f+e.height/2,e.contentsRect.x=o*a/i,e.contentsRect.y=u*f/s,e.contentsRect.width=e.width/i,e.contentsRect.height=e.height/s},downloadScript:function(e){this.delegate=e;if(this.delegate.getKPFJsonStringForShow){this.script=JSON.parse(this.delegate.getKPFJsonStringForShow());if(this.script==null){debugMessageAlways(kDebugScriptMangaer_DownloadScript,"An error occured on the server. KPF header json is null.");return}this.slideManager=new SlideManager({header:this.script}),this.slideManager.getSlides(this.script.slideList,this.delegate);return}this.downloadTimeout=setTimeout(this.scriptDidNotDownload.bind(this),kMaxScriptDownloadWaitTime),this.downloadAlreadyFailed=!1;var t=this.showUrl+"header.json";if(window.location.protocol==="file:"){t+="p",window.local_header=function(e){this.scriptDidDownload(e,!0)}.bind(this);var n=document.createElement("script");n.setAttribute("src",t),document.head.appendChild(n)}else new Ajax.Request(t,{method:"get",onSuccess:this.scriptDidDownload.bind(this),onFailure:this.scriptDidNotDownload.bind(this)})},scriptDidDownload:function(e,t){clearTimeout(this.downloadTimeout),t?this.script=e:this.script=JSON.parse(e.responseText),this.slideManager=new SlideManager({header:this.script}),this.slideManager.downloadSlides(this.script.slideList)},scriptDidNotDownload:function(e){this.downloadAlreadyFailed=!0,e&&clearTimeout(this.downloadTimeout),document.fire(kScriptDidNotDownloadEvent,{})},sceneIndexFromSlideIndex:function(e){return this.script==null||e<0||e>=this.script.slideList.length?-1:this.script.sceneIndexFromSlideIndexLookup[e]},slideIndexFromSceneIndex:function(e){return this.script==null||e<0||e>=this.script.events.length?-1:this.script.slideIndexFromSceneIndexLookup[e]}});