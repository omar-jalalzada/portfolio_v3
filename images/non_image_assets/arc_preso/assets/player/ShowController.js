var kShowControllerState_Stopped="Stopped",kShowControllerState_Starting="Starting",kShowControllerState_DownloadingScript="DownloadingScipt",kShowControllerState_SettingUpScene="SettingUpScene",kShowControllerState_IdleAtFinalState="IdleAtFinalState",kShowControllerState_IdleAtInitialState="IdleAtInitialState",kShowControllerState_WaitingToJump="WaitingToJump",kShowControllerState_ReadyToJump="ReadyToJump",kShowControllerState_WaitingToDisplay="WaitingToDisplay",kShowControllerState_ReadyToDisplay="ReadyToDisplay",kShowControllerState_WaitingToPlay="WaitingToPlay",kShowControllerState_ReadyToPlay="ReadyToPlay",kShowControllerState_Playing="Playing",kKeyDownEvent="keydown",kSlideIndexDidChangeEvent="ShowController:SlideIndexDidChangeEvent",ShowController=Class.create({initialize:function(){this.delegate=extractDelegateFromUrlParameter(),this.delegate.showDidLoad(),this.showUrl="../",this.displayManager=new DisplayManager,this.scriptManager=new ScriptManager(this.showUrl),this.textureManager=new TextureManager(this.showUrl),this.stageManager=new StageManager(this.textureManager,this.scriptManager),this.touchController=new TouchController,this.animationManager=new AnimationManager,this.orientationController=new OrientationController,this.activeHyperlinks=new Array,this.movieHyperlinks=new Array,this.script=null,this.currentSceneIndex=-1,this.nextSceneIndex=-1,this.currentSlideIndex=-1,this.previousSlideIndex=-1,this.currentSoundTrackIndex=0,this.transformOriginValue="",this.accumulatingDigits=!1,this.digitAccumulator=0,this.firstSlide=!0,this.lastSlideViewedIndex=-1,this.accountID="",this.guid="",this.locale="EN",this.isNavigationBarVisible=!1,this.isFullscreen=!1,this.volume=3,this.muted=!1,this.soundTrackPlayer=null,this.sceneIndexOfPrebuiltAnimations=-1,this.queuedUserAction=null,document.observe(kScriptDidDownloadEvent,this.handleScriptDidDownloadEvent.bind(this)),document.observe(kScriptDidNotDownloadEvent,this.handleScriptDidNotDownloadEvent.bind(this)),document.observe(kStageIsReadyEvent,this.handleStageIsReadyEvent.bind(this)),document.observe(kStageSizeDidChangeEvent,this.handleStageSizeDidChangeEvent.bind(this)),document.observe(kFullscreenChangeEventName,this.handleFullscreenChangeEvent.bind(this)),Event.observe(window,"resize",this.handleWindowResizeEvent.bind(this)),this.touchController.registerTapEventCallback(this.handleTapEvent.bind(this)),this.changeState(kShowControllerState_Stopped),this.movieCache=null,this.movieCacheInfo=null,this.audioCache=null,this.playbackController=new KPFPlaybackController({},this.stageManager.stage),this.navigatorController=new NavigatorController(document.getElementById("slideshowNavigator")),this.slideNumberController=new SlideNumberController(document.getElementById("slideNumberControl")),this.slideNumberDisplay=new SlideNumberDisplay(document.getElementById("slideNumberDisplay")),this.helpPlacard=new HelpPlacardController(document.getElementById("helpPlacard")),this.isRecording=!1,this.isRecordingStarted=!1,browserPrefix=="ms"&&browserVersion<10?this.animationSupported=!1:this.animationSupported=!0,document.observe("contextmenu",this.handleContextMenuEvent.bind(this)),document.observe(kKeyDownEvent,this.handleKeyDownEvent.bind(this)),document.observe(kSwipeEvent,this.handleSwipeEvent.bind(this)),Event.observe(this.displayManager.previousButton,"click",this.goBackToPreviousSlide.bind(this,"tapPreviousButton")),Event.observe(this.displayManager.nextButton,"click",this.advanceToNextBuild.bind(this,"tapNextButton"))},startShow:function(){this.changeState(kShowControllerState_DownloadingScript),this.scriptManager.downloadScript(this.delegate)},exitShow:function(e){clearTimeout(this.exitTimeout),e?this.delegate.showExited():this.exitTimeout=setTimeout(function(){this.delegate.showExited()}.bind(this),750)},promptUserToTryAgain:function(e){var t=!1;return t=confirm(e),t},handleScriptDidDownloadEvent:function(e){switch(this.state){case kShowControllerState_DownloadingScript:this.script=e.memo.script,this.script.showMode==kShowModeHyperlinksOnly&&this.displayManager.setHyperlinksOnlyMode(),this.changeState(kShowControllerState_Starting);var t,n=parseInt(getUrlParameter("restartingSceneIndex")),r=document.URL.split("?"),i=r[0].split("#");i[1]&&(n=parseInt(i[1]));if(n)t=n;else{var s=getUrlParameter("currentSlide"),o;s?o=parseInt(s):o=1,t=this.scriptManager.sceneIndexFromSlideIndex(o-1)}if(this.script.recording&&this.script.recording.eventTracks[0].type==="navigation"){this.narrationManager=new NarrationManager(this.script.recording),t=this.narrationManager.sceneIndexFromNavigationEvent(this.narrationManager.navigationEvents[0]),this.isRecording=!0,this.jumpToScene(t,!1);break}if(t>this.script.lastSceneIndex)break;var e=this.script.events[t],u=e.automaticPlay==1||e.automaticPlay==1;this.jumpToScene(t,u);break;default:debugMessage(kDebugShowController_HandleScriptDidDownloadEvent,"- hmmm we seem to have arrived here from an unpredicted state")}},handleScriptDidNotDownloadEvent:function(e){debugMessage(kDebugShowController_HandleScriptDidNotDownloadEvent);var t=this.promptUserToTryAgain(kUnableToReachiWorkTryAgain);t?this.scriptManager.downloadScript():(this.displayManager.clearLaunchMode(),this.displayManager.hideWaitingIndicator())},handleStageIsReadyEvent:function(e){this.isFullscreen?setTimeout(function(){this.displayManager.stageArea.style.opacity=1}.bind(this),50):setTimeout(function(){this.displayManager.stageArea.style.opacity=1}.bind(this),500),this.positionSlideNumberControl(),this.positionSlideNumberDisplay(),this.positionHelpPlacard()},positionSlideNumberControl:function(){var e=(this.displayManager.usableDisplayWidth-this.slideNumberController.width)/2,t=this.displayManager.stageAreaTop+this.displayManager.stageAreaHeight-(this.slideNumberController.height+16);this.slideNumberController.setPosition(e,t)},positionSlideNumberDisplay:function(){var e=(this.displayManager.usableDisplayWidth-this.slideNumberDisplay.width)/2,t=this.displayManager.stageAreaTop+this.displayManager.stageAreaHeight-(this.slideNumberDisplay.height+16);this.slideNumberDisplay.setPosition(e,t)},positionHelpPlacard:function(){var e=(this.displayManager.usableDisplayWidth-this.helpPlacard.width)/2,t=(this.displayManager.usableDisplayHeight-this.helpPlacard.height)/2;this.helpPlacard.setPosition(e,t)},handleFullscreenChangeEvent:function(){document.webkitIsFullScreen||document.mozFullScreen?this.isFullscreen=!0:this.isFullscreen=!1,setTimeout(function(){this.displayManager.layoutDisplay()}.bind(this),0)},handleWindowResizeEvent:function(){clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(this.changeWindowSize.bind(this),1e3)},changeWindowSize:function(){if(this.delegate.setViewScale){this.scriptManager.reapplyScaleFactor(),this.textureManager.slideCache=null,this.textureManager.slideCache={};var e=this.currentSceneIndex;this.state===kShowControllerState_IdleAtFinalState&&(this.currentSceneIndex<this.script.numScenes-1?e=this.currentSceneIndex+1:this.script.loopSlideshow&&(e=0)),this.jumpToScene(e,!1)}document.fire(kShowSizeDidChangeEvent,{width:this.script.slideWidth,height:this.script.slideHeight})},handleStageSizeDidChangeEvent:function(e){this.touchController.setTrackArea(e.memo.left,e.memo.top,e.memo.width,e.memo.height)},handleKeyDownEvent:function(e){var t=e.charCode||e.keyCode;if(t===kKeyCode_F11||t===kKeyCode_F12)return;var n={altKey:!!e.altKey,ctrlKey:!!e.ctrlKey,shiftKey:!!e.shiftKey,metaKey:!!e.metaKey};if(n.metaKey){if(t===kKeyCode_Period||t===kKeyCode_Dot)this.exitShow(!0);else if(t!=kKeyCode_Return)return}else if(n.ctrlKey)return;e.stop(),this.onKeyPress(t,n)},handleContextMenuEvent:function(e){e.stop()},handleClickEvent:function(e){if(this.isRecording)return;var t,n;e.pageX||e.pageY?(t=e.pageX,n=e.pageY):(t=e.clientX,n=e.clientY);var r={pointX:t,pointY:n};browserPrefix==="ms"&&window.focus();if(e.target.nodeName.toLowerCase()==="video")return;this.processClickOrTapAtDisplayCoOrds(r)},handleTapEvent:function(e){var t={pointX:e.memo.pointX,pointY:e.memo.pointY};this.processClickOrTapAtDisplayCoOrds(t)},processClickOrTapAtDisplayCoOrds:function(e){var t=!1,n;if(this.slideNumberController.isShowing){this.slideNumberTimeout&&clearTimeout(this.slideNumberTimeout),this.slideNumberTimeout=setTimeout(this.hideAndResetSlideNumberController.bind(this),0);return}if(this.helpPlacard.isShowing){this.helpPlacard.hide();return}var r=this.displayManager.convertDisplayCoOrdsToShowCoOrds(e);r.pointX!=-1&&(n=this.findHyperlinkAtCoOrds(r)),n?this.processHyperlink(n):this.advanceToNextBuild("processClickOrTapAtDisplayCoOrds")},handleSwipeEvent:function(e){if(e.memo.direction==="left")switch(e.memo.fingers){case 1:this.advanceToNextBuild("handleSwipeEvent");break;case 2:this.advanceToNextSlide("handleSwipeEvent");break;default:}else if(e.memo.direction==="right")switch(e.memo.fingers){case 1:this.goBackToPreviousSlide("handleSwipeEvent");break;case 2:this.goBackToPreviousBuild("handleSwipeEvent");break;default:}},onMouseDown:function(e){e.leftClick?this.advanceToNextBuild("onMouseDown"):e.rightClick&&this.goBackToPreviousBuild("onMouseDown")},onKeyPress:function(e,t){e>=kKeyCode_Numeric_0&&e<=kKeyCode_Numeric_9&&(e=kKeyCode_0+(e-kKeyCode_Numeric_0)),e+=t.shiftKey?kKeyModifier_Shift:0,e+=t.altKey?kKeyModifier_Alt:0,e+=t.ctrlKey?kKeyModifier_Ctrl:0,e+=t.metaKey?kKeyModifier_Meta:0;if(this.isRecording)return;var n=!1;switch(e){case kKeyCode_Escape:this.exitShow(!0);break;case kKeyCode_Slash:case kKeyCode_Slash+kKeyModifier_Shift:this.helpPlacard.isShowing?this.helpPlacard.hide():this.helpPlacard.show();break;case kKeyCode_Q:this.exitShow(!0);break;case kKeyCode_S:this.slideNumberController.isShowing&&(this.slideNumberTimeout&&clearTimeout(this.slideNumberTimeout),this.slideNumberTimeout=setTimeout(this.hideAndResetSlideNumberController.bind(this),0)),this.slideNumberDisplay.isShowing?this.slideNumberDisplay.hide():(this.slideNumberDisplay.setSlideNumber(this.currentSlideIndex+1),this.slideNumberDisplay.show());break;case kKeyCode_Return:if(this.accumulatingDigits){this.accumulatingDigits=!1,this.script.showMode!=kShowModeHyperlinksOnly?(this.digitAccumulator>this.script.slideCount?this.digitAccumulator=this.script.slideCount:this.digitAccumulator<1&&(this.digitAccumulator=1),this.slideNumberController.setSlideNumber(this.digitAccumulator),this.jumpToSlide(this.digitAccumulator)):debugMessage(kDebugShowController_OnKeyPress,"- can't do it, we're in hyperlinks only mode");break};case kKeyCode_N:case kKeyCode_Space:case kKeyCode_DownArrow:case kKeyCode_RightArrow:case kKeyCode_PageDown:case kKeyCode_RightArrow+kKeyModifier_Shift:this.advanceToNextBuild("onKeyPress");break;case kKeyCode_DownArrow+kKeyModifier_Shift:case kKeyCode_PageDown+kKeyModifier_Shift:case kKeyCode_CloseBracket:case kKeyCode_Equal+kKeyModifier_Shift:case kKeyCode_Equal:case kKeyCode_Plus:this.advanceToNextSlide("onKeyPress");break;case kKeyCode_LeftArrow+kKeyModifier_Shift:case kKeyCode_PageUp+kKeyModifier_Shift:case kKeyCode_OpenBracket:this.goBackToPreviousBuild("onKeyPress");break;case kKeyCode_P:case kKeyCode_PageUp:case kKeyCode_LeftArrow:case kKeyCode_UpArrow:case kKeyCode_UpArrow+kKeyModifier_Shift:case kKeyCode_Hyphen:case kKeyCode_Minus:this.goBackToPreviousSlide("onKeyPress");break;case kKeyCode_Delete:n=!0;if(this.accumulatingDigits)if(this.digitAccumulator<10)this.slideNumberTimeout&&clearTimeout(this.slideNumberTimeout),this.slideNumberTimeout=setTimeout(this.hideAndResetSlideNumberController.bind(this),0);else{this.slideNumberTimeout&&clearTimeout(this.slideNumberTimeout),this.slideNumberTimeout=setTimeout(this.hideAndResetSlideNumberController.bind(this),7e3);var r=this.digitAccumulator.toString();this.digitAccumulator=parseInt(r.substring(0,r.length-1)),this.slideNumberController.setSlideNumber(this.digitAccumulator)}break;case kKeyCode_Home:this.script.showMode!=kShowModeHyperlinksOnly?this.jumpToSlide(1):debugMessage(kDebugShowController_OnKeyPress,"- can't do it, we're in hyperlinks only mode");break;case kKeyCode_End:this.script.showMode!=kShowModeHyperlinksOnly?this.jumpToSlide(this.script.slideCount):debugMessage(kDebugShowController_OnKeyPress,"- can't do it, we're in hyperlinks only mode");break;default:this.slideNumberTimeout&&clearTimeout(this.slideNumberTimeout),this.slideNumberTimeout=setTimeout(this.hideAndResetSlideNumberController.bind(this),7e3),e>=kKeyCode_0&&e<=kKeyCode_9?(this.slideNumberDisplay.isShowing&&this.slideNumberDisplay.hide(),n=!0,this.accumulatingDigits===!1&&(this.accumulatingDigits=!0,this.digitAccumulator=0),this.digitAccumulator.toString().length<4&&(this.digitAccumulator*=10,this.digitAccumulator+=e-kKeyCode_0,this.slideNumberController.setSlideNumber(this.digitAccumulator),this.slideNumberController.isShowing||this.slideNumberController.show())):n=!0}this.accumulatingDigits&&n===!1},hideAndResetSlideNumberController:function(){this.slideNumberTimeout&&clearTimeout(this.slideNumberTimeout),this.accumulatingDigits=!1,this.digitAccumulator=0,this.slideNumberController.hide()},hideSlideNumberDisplay:function(){this.slideNumberDisplay.hide()},toggleFullscreen:function(){if(browserPrefix==="ms")return;setTimeout(function(){this.displayManager.stageArea.style.opacity=0}.bind(this),0),this.displayManager.hideHUD(!0),document.webkitIsFullScreen||document.mozFullScreen?(this.isFullscreen=!1,document.webkitCancelFullScreen&&document.webkitCancelFullScreen()||document.mozCancelFullScreen&&document.mozCancelFullScreen()):(this.isFullscreen=!0,document.body.webkitRequestFullScreen&&document.body.webkitRequestFullScreen()||document.body.mozRequestFullScreen&&document.body.mozRequestFullScreen())},changeState:function(e){e!=this.state&&(this.leavingState(),this.state=e,this.enteringState())},leavingState:function(){switch(this.state){case kShowControllerState_Stopped:break;case kShowControllerState_Starting:break;case kShowControllerState_SettingUpScene:break;case kShowControllerState_IdleAtFinalState:break;case kShowControllerState_IdleAtInitialState:break;case kShowControllerState_WaitingToJump:break;case kShowControllerState_ReadyToJump:break;case kShowControllerState_WaitingToPlay:this.displayManager.hideWaitingIndicator();break;case kShowControllerState_ReadyToPlay:break;case kShowControllerState_Playing:}},enteringState:function(){switch(this.state){case kShowControllerState_Stopped:break;case kShowControllerState_Starting:this.displayManager.showWaitingIndicator();break;case kShowControllerState_SettingUpScene:break;case kShowControllerState_IdleAtFinalState:case kShowControllerState_IdleAtInitialState:this.updateSlideNumber(),this.displayManager.hideWaitingIndicator(),this.createHyperlinksForCurrentState("idle"),runInNextEventLoop(this.doIdleProcessing.bind(this));break;case kShowControllerState_WaitingToJump:break;case kShowControllerState_ReadyToJump:break;case kShowControllerState_WaitingToPlay:this.displayManager.showWaitingIndicator();break;case kShowControllerState_ReadyToPlay:break;case kShowControllerState_Playing:}},doIdleProcessing:function(){this.preloadAppropriateScenes();if(this.queuedUserAction!=null)this.queuedUserAction(),this.queuedUserAction=null;else{var e=this.stageManager.stage;e.childNodes.length!=0&&this.updateNavigationButtons()}},truncatedSlideIndex:function(e){return this.truncatedIndex(e,this.script.lastSlideIndex,this.script.loopSlideshow)},truncatedSceneIndex:function(e){return this.truncatedIndex(e,this.script.lastSceneIndex,this.script.loopSlideshow)},truncatedIndex:function(e,t,n){return e<0?n?e=e+t+1:e=-1:e>t&&(n?e=e-t-1:e=-1),e},preloadAppropriateScenes:function(){var e=this.currentSceneIndex;this.state===kShowControllerState_IdleAtFinalState&&e++;var t=this.script.slideIndexFromSceneIndexLookup[e],n=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(t-1)),r=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(t-2)),i=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(t-3)),s=this.truncatedSceneIndex(e-1),o=this.truncatedSceneIndex(e-2),u=this.truncatedSceneIndex(e-3),a=this.truncatedSceneIndex(e+1),f=this.truncatedSceneIndex(e+2),l=this.truncatedSceneIndex(e+3),c=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(t+1)),h=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(t+2)),p=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(t+3)),d={},v=gIpad===!0;!v&&i!=-1&&(d[i]=!0),!v&&r!=-1&&(d[r]=!0),!v&&n!=-1&&(d[n]=!0),!v&&u!=-1&&(d[u]=!0),!v&&o!=-1&&(d[o]=!0),!v&&s!=-1&&(d[s]=!0),d[this.currentSceneIndex]=!0,d[e]=!0,a!=-1&&(d[a]=!0),!v&&f!=-1&&(d[f]=!0),!v&&l!=-1&&(d[l]=!0),!v&&c!=-1&&(d[c]=!0),!v&&h!=-1&&(d[h]=!0),!v&&p!=-1&&(d[p]=!0),this.textureManager.preloadScenes(d)},advanceToNextBuild:function(e){if(this.script.showMode===kShowModeHyperlinksOnly&&e!="currentSceneDidComplete")return!1;if(this.displayManager.infoPanelIsShowing)return!1;var t=!1;switch(this.state){case kShowControllerState_IdleAtFinalState:if(this.nextSceneIndex===-1){if(!this.delegate.getKPFJsonStringForShow){this.stopSoundTrack();break}this.stopSoundTrack(),this.exitShow()}t=!0,this.jumpToScene(this.nextSceneIndex,!0);break;case kShowControllerState_IdleAtInitialState:if(this.currentSceneIndex>=this.script.numScenes)if(this.script.loopSlideshow)t=!0,this.jumpToScene(0,!1);else{if(!this.delegate.getKPFJsonStringForShow){this.stopSoundTrack();break}this.stopSoundTrack(),this.exitShow()}else t=!0,this.playCurrentScene();break;default:debugMessage(kDebugShowController_AdvanceToNextBuild,"nextSceneIndex: "+this.nextSceneIndex+" can't advance now, not in an idle state (currently in '"+this.state+"' state), queue up action to run in next idle time"),this.queuedUserAction==null&&(t=!0,this.queuedUserAction=this.advanceToNextBuild.bind(this,e))}return t},advanceToNextSlide:function(e){if(this.script.showMode==kShowModeHyperlinksOnly)return;if(this.displayManager.infoPanelIsShowing)return;var t=this.currentSceneIndex;switch(this.state){case kShowControllerState_IdleAtFinalState:t+=1;case kShowControllerState_IdleAtInitialState:var n=this.scriptManager.slideIndexFromSceneIndex(t),r;if(n===this.script.slideCount-1){if(!this.script.loopSlideshow)return;r=0}else r=this.currentSlideIndex+1;var i=this.scriptManager.sceneIndexFromSlideIndex(r),s=this.script.events[i],o=s.automaticPlay==1||s.automaticPlay==1;this.jumpToSlide(r+1,o);break;default:debugMessage(kDebugShowController_AdvanceToNextSlide,"can't advance now, not in an idle state (currently in '"+this.state+"' state), queue up action to run in next idle time"),this.queuedUserAction==null&&(this.queuedUserAction=this.advanceToNextSlide.bind(this,e))}},goBackToPreviousBuild:function(e){this.resetMediaCache();if(this.script.showMode==kShowModeHyperlinksOnly)return;if(this.displayManager.infoPanelIsShowing)return;var t=this.currentSceneIndex;switch(this.state){case kShowControllerState_IdleAtFinalState:t+=1;case kShowControllerState_Playing:case kShowControllerState_IdleAtInitialState:var n;if(t===0){if(!this.script.loopSlideshow)return;n=this.script.events.length-1}else n=t-1;this.jumpToScene(n,!1);break;default:debugMessage(kDebugShowController_GoBackToPreviousBuild,"can't go back now, not in an idle state (currently in '"+this.state+"' state)"),this.queuedUserAction==null&&(this.queuedUserAction=this.goBackToPreviousBuild.bind(this,e))}},goBackToPreviousSlide:function(e){if(this.script.showMode==kShowModeHyperlinksOnly)return;if(this.displayManager.infoPanelIsShowing)return;var t=this.currentSceneIndex;switch(this.state){case kShowControllerState_IdleAtFinalState:t+=1;case kShowControllerState_Playing:case kShowControllerState_IdleAtInitialState:var n=this.scriptManager.slideIndexFromSceneIndex(t),r;n===0?this.script.loopSlideshow?r=this.script.slideCount-1:r=0:n===-1&&t>0?r=this.script.slideCount-1:r=this.currentSlideIndex-1,this.jumpToSlide(r+1);break;default:debugMessage(kDebugShowController_GoBackToPreviousSlide,"can't go back now, not in an idle state (currently in '"+this.state+"' state)"),this.queuedUserAction==null&&(this.queuedUserAction=this.goBackToPreviousSlide.bind(this,e))}},calculatePreviousSceneIndex:function(e){return e==-1?previousSceneIndex=-1:previousSceneIndex=e-1,previousSceneIndex},jumpToSlide:function(e,t){var n=e-1,r=this.scriptManager.sceneIndexFromSlideIndex(n);this.resetMediaCache(),t==null&&(t=!1),this.jumpToScene(r,t)},jumpToScene:function(e,t){this.lastSlideViewedIndex=this.scriptManager.slideIndexFromSceneIndex(this.currentSceneIndex);if(e===-1)return;switch(this.state){case kShowControllerState_Starting:var n="position:absolute;background-color:transparent; left:0px; top:0px; width:"+this.displayManager.usableDisplayWidth+"px; height:"+this.displayManager.usableDisplayHeight+"px;";this.starting=!0,this.maskElement=document.createElement("div"),this.maskElement.setAttribute("style",n),document.body.appendChild(this.maskElement);case kShowControllerState_IdleAtInitialState:case kShowControllerState_IdleAtFinalState:case kShowControllerState_ReadyToJump:break;default:debugMessage(kDebugShowController_JumpToScene,"can't jump now, currently in '"+this.state+"' state which does not supports jumping...");return}if(this.textureManager.isScenePreloaded(e)===!1){this.changeState(kShowControllerState_WaitingToJump);var r={sceneIndex:e,automaticPlay:t};this.waitForSceneToLoadTimeout=setTimeout(this.handleSceneDidNotLoad.bind(this,r),kMaxSceneDownloadWaitTime),this.textureManager.loadScene(e,this.handleSceneDidLoad.bind(this,r));return}this.changeState(kShowControllerState_SettingUpScene),runInNextEventLoop(this.jumpToScene_partThree.bind(this,e,t))},handleSceneDidLoad:function(e){clearTimeout(this.waitForSceneToLoadTimeout),this.displayManager.setNextButtonEnabled(this.currentSceneIndex<this.script.pageCount-1);switch(this.state){case kShowControllerState_WaitingToJump:this.changeState(kShowControllerState_ReadyToJump),this.jumpToScene_partTwo(e.sceneIndex,e.automaticPlay);break;default:}},handleSceneDidNotLoad:function(e){clearTimeout(this.waitForSceneToLoadTimeout),this.queuedUserAction=null;var t=this.promptUserToTryAgain(kUnableToReachiWorkTryAgain);if(t){var n=window.location.href,r,i=n.indexOf("&restartingSceneIndex");i===-1?r=n:r=n.substring(0,i);var s=r+"&restartingSceneIndex="+e.sceneIndex;window.location.replace(s)}else this.changeState(kShowControllerState_IdleAtFinalState)},jumpToScene_partTwo:function(e,t){this.changeState(kShowControllerState_SettingUpScene),runInNextEventLoop(this.jumpToScene_partThree.bind(this,e,t))},jumpToScene_partThree:function(e,t){var n=!1;n?runInNextEventLoop(this.jumpToScene_partFour.bind(this,e,t)):this.jumpToScene_partFour(e,t)},jumpToScene_partFour:function(e,t){this.displayScene(e),this.starting&&(this.maskElement!=null&&(document.body.removeChild(this.maskElement),this.maskElement=null,this.starting=!1),window.focus()),this.helpPlacard.isShowing&&this.helpPlacard.hide(),this.slideNumberDisplay.isShowing&&this.slideNumberDisplay.hide(),this.slideNumberController.isShowing&&(this.slideNumberTimeout&&clearTimeout(this.slideNumberTimeout),this.slideNumberTimeout=setTimeout(this.hideAndResetSlideNumberController.bind(this),500)),t?this.playCurrentScene():(this.changeState(kShowControllerState_IdleAtInitialState),this.isRecording&&!this.isRecordingStarted&&(this.narrationManager.start(),this.isRecordingStarted=!0))},displayScene:function(e,t){if(e===-1)return;this.animationManager.deleteAllAnimations();var n=this.scriptManager.slideIndexFromSceneIndex(this.currentSceneIndex),r=t?t.slideIndex:this.scriptManager.slideIndexFromSceneIndex(e);n!=r&&this.resetMediaCache(),this.setCurrentSceneIndexTo(e);if(t)this.playbackController.renderEvent(t);else{var i=this.script.slideIndexFromSceneIndexLookup[e],s=this.script.slideList[i],o=new KPFEvent({slideId:s,slideIndex:i,sceneIndex:e,event:this.script.events[e],animationSupported:this.animationSupported});this.playbackController.renderEvent(o)}this.updateNavigationButtons()},setCurrentSceneIndexTo:function(e){this.currentSceneIndex=e,this.assignNextSceneIndex(),this.updateSlideNumber(),this.updateNavigationButtons()},assignNextSceneIndex:function(){this.nextSceneIndex=this.calculateNextSceneIndex(this.currentSceneIndex)},calculateNextSceneIndex:function(e){var t=this.calculateNextSceneIndex_internal(e);return t},calculateNextSceneIndex_internal:function(e){var t=-1;return e<this.script.lastSceneIndex?t=e+1:this.script.loopSlideshow?t=0:t=-1,t},updateSlideNumber:function(){var e=this.currentSceneIndex;this.state===kShowControllerState_IdleAtFinalState&&(e=this.nextSceneIndex);var t=this.scriptManager.slideIndexFromSceneIndex(e);this.firstSlide&&(runInNextEventLoop(function(){this.startSoundTrack(),this.displayManager.clearLaunchMode()}.bind(this)),this.firstSlide=!1),this.currentSlideIndex!=t&&(this.previousSlideIndex=this.currentSlideIndex,this.currentSlideIndex=t,this.displayManager.updateSlideNumber(this.currentSlideIndex+1,this.script.slideCount),this.delegate.propertyChanged(kPropertyName_currentSlide,this.currentSlideIndex+1),document.fire(kSlideIndexDidChangeEvent,{slideIndex:this.currentSlideIndex}))},updateNavigationButtons:function(){var e=this.currentSceneIndex;this.state===kShowControllerState_IdleAtFinalState&&e++,this.updateWindowHistory(e);var t=!1,n=!1;this.script.lastSceneIndex===-1?(n=!1,t=!1):this.script.loopSlideshow?(n=!0,t=!0):(e>0&&(t=!0),e===0&&this.script.lastSceneIndex===0?n=!0:this.currentSceneIndex<this.script.lastSceneIndex?n=!0:this.currentSceneIndex===this.script.lastSceneIndex?this.state===kShowControllerState_IdleAtInitialState?n=!0:n=!1:n=!1),this.displayManager.setPreviousButtonEnabled(t),this.displayManager.setNextButtonEnabled(n)},playCurrentScene:function(e){var t=this.state,n,r=0,i=this.playbackController.eventOverallEndTime();this.changeState(kShowControllerState_Playing),this.helpPlacard.isShowing&&this.helpPlacard.hide(),this.slideNumberDisplay.isShowing&&this.slideNumberDisplay.hide(),e?n=e.sceneIndexToJump:(n=this.nextSceneIndex,this.playbackController.kpfEvent.event.automaticPlay==1&&this.playbackController.kpfEvent.event.effects[0].type==="transition"&&(r=this.playbackController.kpfEvent.event.effects[0].beginTime,i=this.playbackController.kpfEvent.event.effects[0].duration));if(this.animationSupported){clearTimeout(this.animateTimeout);var s;this.playbackController.kpfEvent.event.effects[0].type==="transition"&&this.playbackController.kpfEvent.event.effects[0].name!="com.apple.iWork.Keynote.BLTBlinds"&&(s=this.playbackController.renderEffects()),this.animateTimeout=setTimeout(function(e){e==null&&(e=this.playbackController.renderEffects()),this.playbackController.animateEffects(e),setTimeout(this.currentSceneDidComplete.bind(this,n),i*1e3+100)}.bind(this,s),r*1e3)}else{var o=this.script.events[this.currentSceneIndex].automaticPlay;n===-1?(this.updateNavigationButtons(),this.delegate.getKPFJsonStringForShow?o?setTimeout(this.exitShow.bind(this),2e3):this.exitShow():this.changeState(kShowControllerState_IdleAtInitialState)):o?setTimeout(function(){this.changeState(kShowControllerState_IdleAtInitialState),this.jumpToScene(n,this.script.events[n].automaticPlay)}.bind(this),2e3):(this.changeState(kShowControllerState_IdleAtInitialState),setTimeout(this.jumpToScene.bind(this,n,this.script.events[n].automaticPlay),100))}},currentSceneDidComplete:function(e){this.slideNumberDisplay.isShowing&&this.slideNumberDisplay.hide(),this.changeState(kShowControllerState_IdleAtFinalState);if(this.script.showMode==kShowModeHyperlinksOnly||e!=-1&&e!=this.nextSceneIndex){var t=this.script.events[e],n=t.automaticPlay==1||t.automaticPlay==1;this.jumpToScene(e,n)}else this.nextSceneIndex===-1?(this.updateNavigationButtons(),this.delegate.getKPFJsonStringForShow?(this.stopSoundTrack(),this.exitShow()):this.stopSoundTrack()):this.script.events[this.nextSceneIndex].automaticPlay&&runInNextEventLoop(this.advanceToNextBuild.bind(this,"currentSceneDidComplete"))},resetMediaCache:function(){this.resetMovieCache(),this.resetAudioCache()},resetMovieCache:function(){for(var e in this.movieCache)delete this.movieCache[e];for(var e in this.movieCacheInfo)delete this.movieCacheInfo[e];this.movieCache=null,this.movieCacheInfo=null},resetAudioCache:function(){for(var e in this.audioCache)delete this.audioCache[e];this.audioCache=null},updateWindowHistory:function(e){if(typeof window.history.replaceState!="undefined"){var t=document.URL.split("?"),n=t[0].split("#");window.history.replaceState(null,"Keynote",n[0]+"#"+e+(t[1]?"?"+t[1]:""))}},startSoundTrack:function(){if(gMode===kModeMobile)return;if(this.script.soundtrack==null)return;if(this.script.soundtrack.mode===kSoundTrackModeOff)return;this.currentSoundTrackIndex=0,this.playNextItemInSoundTrack()},stopSoundTrack:function(){this.soundTrackPlayer&&(this.soundTrackPlayer.stopObserving("ended"),this.soundTrackPlayer.pause(),this.soundTrackPlayer=null)},playNextItemInSoundTrack:function(){var e=this.script.soundtrack.tracks[this.currentSoundTrackIndex];this.soundTrackPlayer=new Audio,this.soundTrackPlayer.src="../"+e,this.soundTrackPlayer.volume=this.script.soundtrack.volume,this.soundTrackPlayer.observe("ended",this.soundTrackItemDidComplete.bind(this),!1),this.soundTrackPlayer.load(),this.soundTrackPlayer.play()},soundTrackItemDidComplete:function(){this.currentSoundTrackIndex++,this.currentSoundTrackIndex<this.script.soundtrack.tracks.length?this.playNextItemInSoundTrack():this.script.soundtrack.mode===kSoundTrackModePlayOnce?this.soundTrackPlayer=null:this.script.soundtrack.mode===kSoundTrackModeLooping&&this.startSoundTrack()},processHyperlink:function(e){var t=e.url,n;if(t.indexOf("?slide=")===0){var r=t.substring(7),i=-1;if(r==="first")i=0;else if(r==="last")i=this.script.slideCount-1;else{var s=this.currentSceneIndex,o=-1;switch(this.state){case kShowControllerState_IdleAtFinalState:s+=1;case kShowControllerState_IdleAtInitialState:var u=this.scriptManager.slideIndexFromSceneIndex(s);r==="next"?u===this.script.slideCount-1?this.script.loopSlideshow?o=0:this.delegate.getKPFJsonStringForShow&&this.exitShow():o=u+1:r==="previous"&&(u===0?this.script.loopSlideshow?o=this.script.slideCount-1:o=0:o=u-1);break;default:}i=o}i!=-1&&this.jumpToHyperlinkSlide(i,e)}else if(t.indexOf("?slideid=")===0){var a=t.substring(9),f=this.script.slideList,i=-1;for(var l=0,c=f.length;l<c;l++)if(f[l]===a){i=l;break}i!=-1&&this.jumpToHyperlinkSlide(i,e)}else t.indexOf("?action=retreat")===0?this.lastSlideViewedIndex!=-1&&this.jumpToHyperlinkSlide(this.lastSlideViewedIndex,e):t.indexOf("?action=exitpresentation")===0?this.exitShow():t.indexOf("http:")===0?window.open(t,"_blank",null):t.indexOf("mailto:")===0&&(window.location=t)},jumpToHyperlinkSlide:function(e,t){var n=t.events,r=this.script.sceneIndexFromSlideIndexLookup[e];if(n){var i=this.script.slideList[e],s=n[i];if(s){var o=this.currentSceneIndex;switch(this.state){case kShowControllerState_IdleAtFinalState:o<this.script.numScenes-1?o+=1:this.script.loopSlideshow&&(o=0);case kShowControllerState_IdleAtInitialState:var u=this.script.slideIndexFromSceneIndexLookup[o],a=this.script.slideList[u],f=new KPFEvent({slideId:a,slideIndex:u,sceneIndex:o,event:s,animationSupported:this.animationSupported});this.displayScene(o,f),this.playCurrentScene({sceneIndexToJump:r});break;default:return}}else{var l=this.script.events[r],c=l.automaticPlay==1||l.automaticPlay==1;this.jumpToSlide(e+1,c)}}else{var l=this.script.events[r],c=l.automaticPlay==1||l.automaticPlay==1;this.jumpToSlide(e+1,c)}},addMovieHyperlink:function(e,t){var n={targetRectangle:e,url:t};this.movieHyperlinks.push(n)},clearMovieHyperlinks:function(){delete this.movieHyperlinks,this.movieHyperlinks=new Array},clearAllHyperlinks:function(){this.stageManager.clearAllHyperlinks(),delete this.activeHyperlinks,this.activeHyperlinks=new Array},findHyperlinkAtCoOrds:function(e){var t=this.activeHyperlinks!=null?this.activeHyperlinks.length:0;for(var n=t;n>0;n--){var r=this.activeHyperlinks[n-1],i=r.targetRectangle;hyperlinkLeft=Math.floor(i.x),hyperlinkTop=Math.floor(i.y),hyperlinkRight=hyperlinkLeft+Math.floor(i.width),hyperlinkBottom=hyperlinkTop+Math.floor(i.height);if(e.pointX>=hyperlinkLeft&&e.pointX<=hyperlinkRight&&e.pointY>=hyperlinkTop&&e.pointY<=hyperlinkBottom)return r}return null},createHyperlinksForCurrentState:function(e){var t=-1;switch(this.state){case kShowControllerState_IdleAtInitialState:t=this.currentSceneIndex;break;case kShowControllerState_IdleAtFinalState:this.currentSceneIndex<this.script.lastSceneIndex?t=this.currentSceneIndex+1:this.script.showMode==kShowModeHyperlinksOnly?t=this.currentSceneIndex:this.script.loopSlideshow&&(t=0);break;default:}t!=-1&&(this.clearAllHyperlinks(),this.createHyperlinks
(t))},createHyperlinks:function(e){if(e===-1)return;var t=this.script.events[e];if(t==null)return;var n=t.hyperlinks;if(n==null)return;var r=n.length,i,s=150,o=50,u=this.displayManager.showWidth,a=this.displayManager.showHeight;for(i=0;i<r;i++){var f=n[i],l=f.targetRectangle,c={targetRectangle:l,events:f.events,url:f.url},h=l.x,p=l.y,d=u-(l.x+l.width),v=a-(l.y+l.top);if(gMode===kModeMobile){if(l.width<s){var m=s-l.width,g=m/2,y=m/2;h<g?g=h:d<y&&(g+=y-d),c.targetRectangle.x-=g,c.targetRectangle.width+=m}if(l.height<o){var b=o-l.height,w=b/2,E=b/2;p<w?w=p:v<E&&(w+=y-d),c.targetRectangle.y-=w,c.targetRectangle.height+=b}}this.stageManager.addHyperlink(c.targetRectangle),this.activeHyperlinks[i]=c}if(this.movieHyperlinks.length>0)for(var S=0;S<this.movieHyperlinks.length;S++){var x=this.movieHyperlinks[S];this.stageManager.addHyperlink(x.targetRectangle),this.activeHyperlinks[i++]=x}}});