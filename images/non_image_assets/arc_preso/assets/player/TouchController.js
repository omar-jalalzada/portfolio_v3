var kTouchStartEventName="touchstart",kTouchMoveEventName="touchmove",kTouchEndEventName="touchend",kTouchCancelEventName="touchcancel",kGestureStartEventName="gesturestart",kGestureEndEventName="gestureend",kSwipeEvent="TouchController:SwipeEvent",kTapEvent="TouchController:TapeEvent",TouchController=Class.create({initialize:function(){document.observe(kTouchStartEventName,this.handleTouchStartEvent.bind(this)),document.observe(kTouchMoveEventName,this.handleTouchMoveEvent.bind(this)),document.observe(kTouchEndEventName,this.handleTouchEndEvent.bind(this)),document.observe(kTouchCancelEventName,this.handleTouchCancelEvent.bind(this)),document.observe(kGestureStartEventName,this.handleGestureStartEvent.bind(this)),document.observe(kGestureEndEventName,this.handleGestureEndEvent.bind(this)),this.swipeInProgress=!1,this.swipeFingerCount=0,this.swipeStartTime=0,this.swipeStartX=0,this.swipeStartY=0,this.preventDefault=!0,this.tapEventCallback=null,this.setTrackArea(0,0,0,0),this.enableTouchTracking=!0},setTouchTrackingEnabled:function(e){this.enableTouchTracking=e},setTrackArea:function(e,t,n,r){debugMessage(kDebugTouchController_SetTrackArea,"left: "+e+" top: "+t+" width: "+n+" height: "+r),this.trackAreaLeft=e,this.trackAreaTop=t,this.trackAreaRight=e+n,this.trackAreaBottom=t+r},registerTapEventCallback:function(e){this.tapEventCallback=e},isTouchWithinTrackArea:function(e){return debugMessage(kDebugTouchController_IsTouchWithinTrackArea,"checking..."),this.enableTouchTracking===!1?(debugMessage(kDebugTouchController_IsTouchWithinTrackArea,"- nope, tracking is disabled"),!1):e.clientX<this.trackAreaLeft?(debugMessage(kDebugTouchController_IsTouchWithinTrackArea,"- nope, x < left"),!1):e.clientX>this.trackAreaRight?(debugMessage(kDebugTouchController_IsTouchWithinTrackArea,"- nope, x > right"),!1):e.clientY<this.trackAreaTop?(debugMessage(kDebugTouchController_IsTouchWithinTrackArea,"- nope, y < top"),!1):e.clientY>this.trackAreaBottom?(debugMessage(kDebugTouchController_IsTouchWithinTrackArea,"- nope, y > bottom"),!1):(debugMessage(kDebugTouchController_IsTouchWithinTrackArea,"- yes it is!"),!0)},handleTouchStartEvent:function(e){debugMessage(kDebugTouchController_HandleTouchStartEvent,"touch event has "+e.touches.length+" fingers...");if(this.swipeInProgress===!1){debugMessage(kDebugTouchController_HandleTouchStartEvent,"- this is the first finger down event...");var t=e.touches[0];this.isTouchWithinTrackArea(t)?(debugMessage(kDebugTouchController_HandleTouchStartEvent,"- start tracking a swipt event..."),this.preventDefault&&e.preventDefault(),this.swipeInProgress=!0,this.swipeFingerCount=e.touches.length,this.swipeStartTime=new Date,this.swipeStartX=t.clientX,this.swipeStartY=t.clientY):debugMessage(kDebugTouchController_HandleTouchStartEvent,"- but it is outside of the track area")}else debugMessage(kDebugTouchController_HandleTouchStartEvent,"- this is a subsequent finger down event. update finger count..."),e.touches.length>this.swipeFingerCount&&(this.swipeFingerCount=e.touches.length,debugMessage(kDebugTouchController_HandleTouchStartEvent,"- this.swipeFingerCount:"+this.swipeFingerCount))},handleTouchMoveEvent:function(e){this.preventDefault&&e.preventDefault(),debugMessage(kDebugTouchController_HandleTouchCancelEvent,"")},handleTouchEndEvent:function(e){debugMessage(kDebugTouchController_HandleTouchEndEvent,"touch event has "+e.touches.length+" fingers...");if(this.swipeInProgress){this.preventDefault&&e.preventDefault();if(e.touches.length===0){debugMessage(kDebugTouchController_HandleTouchEndEvent,"-  "+this.swipeFingerCount+" finger swipe is complete.");var t=e.changedTouches[0],n=document.viewport.getDimensions(),r=n.width/3,i=n.height/3,s=n.width/3,o=t.clientX-this.swipeStartX,u=t.clientY-this.swipeStartY,a=Math.abs(o),f=Math.abs(u),l=new Date,c=l-this.swipeStartTime,h=!1,p=!1,d=400,v=20;c<d?(debugMessage(kDebugTouchController_HandleTouchEndEvent,"-  elapsed time was short enough to be a tap, check its magnitude..."),a<v&&f<v?h=!0:debugMessage(kDebugTouchController_HandleTouchEndEvent,"-  magnitude time too big to be a tap, check if it's a swipe...")):debugMessage(kDebugTouchController_HandleTouchEndEvent,"-  elapsed time too long to be a tap, check if it's a swipe..."),c>800?debugMessage(kDebugTouchController_HandleTouchEndEvent,"-  elapsed time too long to be a swipe, ignoring..."):a>f?f>i?debugMessage(kDebugTouchController_HandleTouchEndEvent,"-  vertical magnitude too high, ignoring..."):p=!0:a>s?debugMessage(kDebugTouchController_HandleTouchEndEvent,"-  horizontal magnitude too high, ignoring..."):p=!0;if(h){debugMessage(kDebugTouchController_HandleTouchEndEvent,"-  it's a "+this.swipeFingerCount+" finger tap");if(this.tapEventCallback){var e={};e.memo={},e.memo.fingers=this.swipeFingerCount,e.memo.pointX=t.clientX,e.memo.pointY=t.clientY,debugMessage(kDebugTouchController_HandleTouchEndEvent,"- invoking callback with pointX: "+t.clientX+" pointY: "+t.clientY+"..."),this.tapEventCallback(e),debugMessage(kDebugTouchController_HandleTouchEndEvent,"- back from callback")}else debugMessage(kDebugTouchController_HandleTouchEndEvent,"- firing TapEvent..."),document.fire(kTapEvent,{fingers:this.swipeFingerCount,pointX:t.clientX,pointY:t.clientY})}else if(p){var m;a>f?m=o<0?"left":"right":m=u<0?"up":"down",debugMessage(kDebugTouchController_HandleTouchEndEvent,"-  it's a "+this.swipeFingerCount+" finger swipe in the "+m+" direction"),document.fire(kSwipeEvent,{direction:m,fingers:this.swipeFingerCount})}this.swipeInProgress=!1,this.swipeFingerCount=0}}else debugMessage(kDebugTouchController_HandleTouchEndEvent,"-  false alarm. swipe has already ended.")},handleTouchCancelEvent:function(e){debugMessage(kDebugTouchController_HandleTouchCancelEvent,""),this.swipeInProgress=!1},handleGestureStartEvent:function(e){debugMessage(kDebugTouchController_HandleGestureStartEvent,""),this.preventDefault&&e.preventDefault()},handleGestureEndEvent:function(e){debugMessage(kDebugTouchController_HandleGestureEndEvent,""),this.preventDefault&&e.preventDefault()}});